apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-app
  namespace: argocd
spec:
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 58.2.0
    helm:
      values: |
        # ğŸ”¥ Prometheus Operator ì¶©ëŒ ë°©ì§€ ì„¤ì •
        prometheusOperator:
          admissionWebhooks:
            enabled: false  # Admission Webhook ì™„ì „ ë¹„í™œì„±í™”
            patch:
              enabled: false
          tls:
            enabled: false  # TLS ë¹„í™œì„±í™”ë¡œ ì¶©ëŒ ë°©ì§€
        
        # ğŸ”¥ ì „ì—­ ì„¤ì •
        namespaceOverride: "monitoring"
        
        # ğŸ”¥ ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸ ì„¤ì •
        prometheus:
          enabled: true
          prometheusSpec:
            retention: 15d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi
        
        grafana:
          enabled: true
          persistence:
            enabled: true
            size: 5Gi
          adminPassword: admin123
        
        alertmanager:
          enabled: true
          alertmanagerSpec:
            retention: 168h
            storage:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi
        
        # ğŸ”¥ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ì„¤ì •
        kubeApiServer:
          enabled: true
        kubelet:
          enabled: true
        kubeControllerManager:
          enabled: true
        coreDns:
          enabled: true
        kubeEtcd:
          enabled: true
        kubeScheduler:
          enabled: true
        kubeProxy:
          enabled: true
        kubeStateMetrics:
          enabled: true
        nodeExporter:
          enabled: true
        
        # ğŸ”¥ ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì •
        defaultRules:
          create: true
          rules:
            alertmanager: true
            etcd: true
            configReloaders: true
            general: true
            k8s: true
            kubeApiserverAvailability: true
            kubeApiserverBurnrate: true
            kubeApiserverHistogram: true
            kubeApiserverSlos: true
            kubelet: true
            kubeProxy: true
            kubePrometheusGeneral: true
            kubePrometheusNodeRecording: true
            kubernetesApps: true
            kubernetesResources: true
            kubernetesStorage: true
            kubernetesSystem: true
            kubeScheduler: true
            kubeStateMetrics: true
            network: true
            node: true
            nodeExporterAlerting: true
            nodeExporterRecording: true
            prometheus: true
            prometheusOperator: true

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true  # ğŸ”¥ ì„œë²„ì‚¬ì´ë“œ ì ìš©ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€
      - ApplyOutOfSyncOnly=true  # ğŸ”¥ ë³€ê²½ëœ ê²ƒë§Œ ì ìš©
      - PrunePropagationPolicy=foreground  # ğŸ”¥ ì•ˆì „í•œ ì‚­ì œ
      - PruneLast=true  # ğŸ”¥ ë§ˆì§€ë§‰ì— ì •ë¦¬
  ignoreDifferences:
    - group: ""
      kind: ConfigMap
      namespace: monitoring
      jsonPointers:
        - /data
    - group: ""
      kind: Secret
      namespace: monitoring
      jsonPointers:
        - /data
    # ğŸ”¥ Admission Webhook ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ë¬´ì‹œ
    - group: "admissionregistration.k8s.io"
      kind: ValidatingAdmissionWebhook
      jsonPointers:
        - /webhooks
    - group: "admissionregistration.k8s.io"
      kind: MutatingAdmissionWebhook
      jsonPointers:
        - /webhooks

    - group: "rbac.authorization.k8s.io"
      kind: ClusterRole
      jsonPointers:
        - /rules
    - group: "rbac.authorization.k8s.io"
      kind: ClusterRoleBinding
      jsonPointers:
        - /subjects
    - group: "rbac.authorization.k8s.io"
      kind: Role
      jsonPointers:
        - /rules
    - group: "rbac.authorization.k8s.io"
      kind: RoleBinding
      jsonPointers:
        - /subjects
    - group: "apiextensions.k8s.io"
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle