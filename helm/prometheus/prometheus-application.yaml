apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prometheus-app
  namespace: argocd
spec:
  project: default
  source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 58.2.0
    helm:
      values: |
        # 🔥 Prometheus Operator 충돌 방지 설정
        prometheusOperator:
          admissionWebhooks:
            enabled: false  # Admission Webhook 완전 비활성화
            patch:
              enabled: false
          tls:
            enabled: false  # TLS 비활성화로 충돌 방지
        
        # 🔥 전역 설정
        namespaceOverride: "monitoring"
        
        # 🔥 기본 컴포넌트 설정
        prometheus:
          enabled: true
          prometheusSpec:
            retention: 15d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi
        
        grafana:
          enabled: true
          persistence:
            enabled: true
            size: 5Gi
          adminPassword: admin123
        
        alertmanager:
          enabled: true
          alertmanagerSpec:
            retention: 168h
            storage:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi
        
        # 🔥 충돌 방지를 위한 추가 설정
        kubeApiServer:
          enabled: true
        kubelet:
          enabled: true
        kubeControllerManager:
          enabled: true
        coreDns:
          enabled: true
        kubeEtcd:
          enabled: true
        kubeScheduler:
          enabled: true
        kubeProxy:
          enabled: true
        kubeStateMetrics:
          enabled: true
        nodeExporter:
          enabled: true
        
        # 🔥 리소스 제한 설정
        defaultRules:
          create: true
          rules:
            alertmanager: true
            etcd: true
            configReloaders: true
            general: true
            k8s: true
            kubeApiserverAvailability: true
            kubeApiserverBurnrate: true
            kubeApiserverHistogram: true
            kubeApiserverSlos: true
            kubelet: true
            kubeProxy: true
            kubePrometheusGeneral: true
            kubePrometheusNodeRecording: true
            kubernetesApps: true
            kubernetesResources: true
            kubernetesStorage: true
            kubernetesSystem: true
            kubeScheduler: true
            kubeStateMetrics: true
            network: true
            node: true
            nodeExporterAlerting: true
            nodeExporterRecording: true
            prometheus: true
            prometheusOperator: true

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true  # 🔥 서버사이드 적용으로 충돌 방지
      - ApplyOutOfSyncOnly=true  # 🔥 변경된 것만 적용
      - PrunePropagationPolicy=foreground  # 🔥 안전한 삭제
      - PruneLast=true  # 🔥 마지막에 정리
  ignoreDifferences:
    - group: ""
      kind: ConfigMap
      namespace: monitoring
      jsonPointers:
        - /data
    - group: ""
      kind: Secret
      namespace: monitoring
      jsonPointers:
        - /data
    # 🔥 Admission Webhook 관련 리소스 무시
    - group: "admissionregistration.k8s.io"
      kind: ValidatingAdmissionWebhook
      jsonPointers:
        - /webhooks
    - group: "admissionregistration.k8s.io"
      kind: MutatingAdmissionWebhook
      jsonPointers:
        - /webhooks

    - group: "rbac.authorization.k8s.io"
      kind: ClusterRole
      jsonPointers:
        - /rules
    - group: "rbac.authorization.k8s.io"
      kind: ClusterRoleBinding
      jsonPointers:
        - /subjects
    - group: "rbac.authorization.k8s.io"
      kind: Role
      jsonPointers:
        - /rules
    - group: "rbac.authorization.k8s.io"
      kind: RoleBinding
      jsonPointers:
        - /subjects
    - group: "apiextensions.k8s.io"
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle